// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===========================================================
 * ENUMS
 * ===========================================================
 */

enum UsuarioTokenTipo {
  activate_account
  update_pass
}

enum VacanteEstado {
  abierta
  pausada
  cerrada
  cancelada
}

enum VacanteEtapaEstado {
  pendiente
  en_progreso
  cumplida
  vencida
  omitida // por si saltás una etapa justificadamente
}

/**
 * ===========================================================
 * CATÁLOGOS Y ORGANIZACIÓN
 * ===========================================================
 */

model Empresa {
  id          String  @id @default(uuid()) @db.Uuid
  nombre      String
  razonSocial String?
  ruc         String?

  // auditoría
  uc String? // usuario creación
  fc DateTime @default(now()) @db.Timestamptz(6) // fecha creación
  um String? // usuario modificación
  fm DateTime @updatedAt @db.Timestamptz(6) // fecha modificación

  // relaciones
  sedes         Sede[]
  departamentos Departamento[]
  usuarios      Usuario[]
  etapas        Etapa[]      
  vacantes      Vacante[]      

  @@unique([nombre])
  @@map("Empresa")
}

model Sede {
  id        String  @id @default(uuid()) @db.Uuid
  empresaId String  @db.Uuid
  nombre    String
  codigo    String?
  direccion String?
  ciudad    String?
  region    String?
  pais      String?
  timezone  String?

  // auditoría
  uc String? // usuario creación
  fc DateTime @default(now()) @db.Timestamptz(6) // fecha creación
  um String? // usuario modificación
  fm DateTime @updatedAt @db.Timestamptz(6) // fecha modificación

  empresa    Empresa      @relation(fields: [empresaId], references: [id], onDelete: Restrict)
  usuarios   Usuario[]
  vacantes   Vacante[]

  @@unique([empresaId, nombre])
  @@index([empresaId])
  @@map("Sede")
}

model Departamento {
  id        String  @id @default(uuid()) @db.Uuid
  empresaId String  @db.Uuid
  nombre    String
  codigo    String?
  parentId  String? @db.Uuid

  // auditoría
  uc String?
  fc DateTime @default(now()) @db.Timestamptz(6)
  um String?
  fm DateTime @updatedAt @db.Timestamptz(6)

  empresa    Empresa        @relation(fields: [empresaId], references: [id], onDelete: Restrict)
  parent     Departamento?  @relation("DepartamentoToDepartamento", fields: [parentId], references: [id], onDelete: SetNull)
  children   Departamento[] @relation("DepartamentoToDepartamento")
  usuarios   Usuario[]
  vacantes   Vacante[] 
  etapasResponsables   VacanteEtapa[]

  // Departamentos GLOBALes por empresa
  @@unique([empresaId, nombre])
  @@index([empresaId, parentId])
  @@map("Departamento")
}

/**
 * ===========================================================
 * USUARIOS Y SEGURIDAD
 * ===========================================================
 */

model Usuario {
  id             String  @id @default(uuid()) @db.Uuid
  empresaId      String  @db.Uuid
  rolId          String? @db.Uuid
  departamentoId String? @db.Uuid
  sedeId         String? @db.Uuid

  username String
  password String   // hash de la contraseña
  email    String
  nombre   String?
  apellido String?
  telefono String?
  activo   Boolean @default(true)
  lastLogin DateTime? @db.Timestamptz(6)

  // auditoría
  uc String?
  fc DateTime @default(now()) @db.Timestamptz(6)
  um String?
  fm DateTime @updatedAt @db.Timestamptz(6)

  empresa      Empresa       @relation(fields: [empresaId], references: [id], onDelete: Restrict)
  rol          Rol?          @relation(fields: [rolId], references: [id], onDelete: Restrict)
  departamento Departamento? @relation(fields: [departamentoId], references: [id], onDelete: SetNull)
  sede         Sede?         @relation(fields: [sedeId], references: [id], onDelete: SetNull)
  tokens       UsuarioToken[]

  // Unicidad por empresa para username y email (multi-tenant)
  @@unique([empresaId, username])
  @@unique([empresaId, email])
  @@index([empresaId])
  @@index([departamentoId])
  @@index([sedeId])
  @@index([rolId])
  @@map("Usuario")
}

model Rol {
  id          String  @id @default(uuid()) @db.Uuid
  nombre      String
  descripcion String?

  // auditoría
  uc String?
  fc DateTime @default(now()) @db.Timestamptz(6)
  um String?
  fm DateTime @updatedAt @db.Timestamptz(6)

  usuarios Usuario[]

  @@unique([nombre])
  @@map("Rol")
}

model Captcha {
  id         String   @id @default(uuid()) @db.Uuid
  ip         String                                  // IP del cliente que solicitó el captcha
  challenge  String                                  // identificador/valor del reto (p.ej. UUID o token)
  
  // auditoría
  fc DateTime @default(now()) @db.Timestamptz(6)

  @@unique([challenge, ip])
  @@index([ip])
  @@map("Captcha")
}

model UsuarioToken {
  id         String           @id @default(uuid()) @db.Uuid   // el propio token
  usuarioId  String           @db.Uuid
  tipo       UsuarioTokenTipo
  fc         DateTime         @default(now()) @db.Timestamptz(6)
  expiresAt  DateTime         @db.Timestamptz(6)

  usuario    Usuario          @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiresAt])
  @@index([tipo])
  @@map("Usuario_Token")
}

/**
 * ===========================================================
 * KARAKU
 * ===========================================================
 */

model Etapa {
  id        String  @id @default(uuid()) @db.Uuid
  empresaId String  @db.Uuid
  nombre    String
  slaDias   Int     // SLA base en días (útil como default)

  // auditoría
  uc String?
  fc DateTime @default(now()) @db.Timestamptz(6)
  um String?
  fm DateTime @updatedAt @db.Timestamptz(6)

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Restrict)
  vacantesEtapas VacanteEtapa[]

  @@unique([empresaId, nombre])
  @@index([empresaId])
  @@map("Etapa")
}

model Vacante {
  id           String  @id @default(uuid()) @db.Uuid
  empresaId    String  @db.Uuid
  sedeId       String? @db.Uuid
  departamentoId String? @db.Uuid // área solicitante
  nombre       String
  activo       Boolean @default(true)
  estado       VacanteEstado @default(abierta)
  fechaInicio  DateTime? @db.Timestamptz(6) // inicio del proceso (arrancan etapas)

  // auditoría
  uc String?
  fc DateTime @default(now()) @db.Timestamptz(6)
  um String?
  fm DateTime @updatedAt @db.Timestamptz(6)

  empresa      Empresa      @relation(fields: [empresaId], references: [id], onDelete: Restrict)
  sede         Sede?        @relation(fields: [sedeId], references: [id], onDelete: SetNull)
  departamento Departamento?@relation(fields: [departamentoId], references: [id], onDelete: SetNull)
  etapas       VacanteEtapa[]

  @@index([empresaId])
  @@index([empresaId, activo])
  @@index([empresaId, estado])
  @@index([empresaId, fechaInicio])
  @@map("Vacante")
}

model VacanteEtapa {
  id           String   @id @default(uuid()) @db.Uuid
  vacanteId    String   @db.Uuid
  etapaId      String   @db.Uuid
  departamentoId String? @db.Uuid // área responsable de ejecutar la etapa (puede no estar definido al crear)
  orden        Int      // consecutivo dentro de la vacante

  // snapshot del SLA y fechas de planificación/ejecución
  slaDias            Int        // copia del catálogo en el momento de planificar
  fechaInicio        DateTime?  @db.Timestamptz(6) // cuándo inicia realmente
  fechaFinPlan       DateTime?  @db.Timestamptz(6) // fechaInicio + slaDias (calculada en servicio)
  fechaCumplimiento  DateTime?  @db.Timestamptz(6) // cuándo terminó realmente
  retrasoDias        Int?       // opcional (puede calcularse on-the-fly, pero útil para reportes)
  estado             VacanteEtapaEstado @default(pendiente)
  comentarios        String?
  recursos           String?    // URL/slug a recursos (más adelante lo normalizamos a tabla)

  // auditoría
  uc String?
  fc DateTime @default(now()) @db.Timestamptz(6)
  um String?
  fm DateTime @updatedAt @db.Timestamptz(6)

  vacante      Vacante      @relation(fields: [vacanteId], references: [id], onDelete: Cascade)
  etapa        Etapa        @relation(fields: [etapaId], references: [id], onDelete: Restrict)
  departamento Departamento?@relation(fields: [departamentoId], references: [id], onDelete: SetNull)

  @@unique([vacanteId, orden])
  @@index([vacanteId])
  @@index([etapaId])
  @@index([departamentoId])
  @@index([estado])
  @@map("Vacante_Etapa")
}
